## Notebook Projeto de Data Science
### Pacotes
install.packages("readr")
install.packages("dplyr")
install.packages("tidyr")
install.packages("ggplot2")
install.packages("googleVis")


### Avaliação dos Dados Fornecidos pelo CertBR


### Bibliotecas
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)


### Suprimindo mensagens de warning 
searchpaths()
suppressMessages(library(dplyr))


### Consciência situacional
orig <- getwd()
orig
setwd(orig)

file.exists("./CertBR.csv")
file <- "./CertBR.csv"

tamanho <- file.info(file)$size
tamanho


### Importando o arquivo (https://www.cert.br/stats/incidentes/)
df <- read.csv2(file, header = TRUE, sep =";", dec=",", stringsAsFactors = FALSE, encoding = "UTF-8")
df <- as.data.frame(df)


### Entendendo o dataframe
head(df)
class(df)
str(df)
summary(df)
sample_n(df, size = 5)


### Conversões das colunas
df$Total <- as.integer(df$Total)
df$Worm <- as.integer(df$Worm)
df$Worm_P <- as.double(df$Worm_P)
df$DOS <- as.integer(df$DOS)
df$DOS_P <- as.double(df$DOS_P)
df$Invasao <- as.integer(df$Invasao)
df$Invasao_P <- as.double(df$Invasao_P)
df$Web <- as.integer(df$Web)
df$Web_P <- as.double(df$Web_P)
df$Scan <- as.integer(df$Scan)
df$Scan_P <- as.double(df$Scan_P)
df$Fraude <- as.integer(df$Fraude)
df$Fraude_P <- as.double(df$Fraude_P)


### Remover NAs (Subsituir por zero)
df[is.na(df)] <- 0 
sample_n(df, size = 10)


### Verificar se o Total corresponde à soma das demais colunas
df$Total -  (df$Worm + df$DOS + df$Invasao + df$Web + df$Scan + df$Fraude)


### Acrescentar e validar a coluna "Outros"
df$Outros <- df$Total - (df$Worm + df$DOS + df$Invasao + df$Web + df$Scan + df$Fraude)
df$Outros <- as.integer(df$Outros)
df$Total -  (df$Worm + df$DOS + df$Invasao + df$Web + df$Scan + df$Fraude + df$Outros)


### Acresdentar coluna com valores percentuais para "Outros"
df$Outros_P <- as.double(df$Outros / df$Total)


### Overview: identificar se há problemas no arredondamento dos valores (se a soma de percentuais é 100)
glimpse(df)
glimpse(mutate(df, Soma100 = Worm_P + DOS_P + Invasao_P + Web_P + Scan_P + Fraude_P + Outros_P))
glimpse(mutate(df, Soma = Worm + DOS + Invasao + Web + Scan + Fraude + Outros))


### Corrigindo os arredondamentos e a representação (duas casas decimais):
df$Worm_P <- as.double(df$Worm / df$Total)
df$DOS_P <- as.double(df$DOS / df$Total)
df$Invasao_P <- as.double(df$Invasao / df$Total)
df$Web_P <- as.double(df$Web / df$Total)
df$Scan_P <- as.double(df$Scan / df$Total)
df$Fraude_P <- as.double(df$Fraude / df$Total)
df$Outros_P <- as.double(df$Outros / df$Total)


### Validar a soma de valores percentuais
glimpse(mutate(df, Soma100 = Worm_P + DOS_P + Invasao_P + Web_P + Scan_P + Fraude_P + Outros_P))


### Corrigindo os arredondamentos e a representação (duas casas decimais):
df$Worm_P <- as.double(sprintf("%0.2f", (df$Worm / df$Total)))
df$DOS_P <- as.double(sprintf("%0.2f", (df$DOS / df$Total)))
df$Invasao_P <- as.double(sprintf("%0.2f", (df$Invasao / df$Total)))
df$Web_P <- as.double(sprintf("%0.2f", (df$Web / df$Total)))
df$Scan_P <- as.double(sprintf("%0.2f", (df$Scan / df$Total)))
df$Fraude_P <- as.double(sprintf("%0.2f", (df$Fraude / df$Total)))
df$Outros_P <- as.double(sprintf("%0.2f", (df$Outros / df$Total)))


### Após o arredondamento há uma instabilidade leve
glimpse(mutate(df, Soma100 = Worm_P + DOS_P + Invasao_P + Web_P + Scan_P + Fraude_P + Outros_P))


### Overview
sample_n(df, size = 5)


### Seleção de partes
dfData <- select(df, Ano, Mes, Total)
head(dfData)
class(dfData)
dfSelect <- select(df, Ano:Total)
sample_n(dfSelect, size = 5)


### Verificar se constam as informações de todos os 12 meses
count(df, Ano)


### Filtrar valores significativos
filter(df, Total > 100000)
filter(df, Total > 50000, Fraude > 100000)
filter(df, Total > 50000, Fraude > 100000, Mes %in% c("ago", "set"), Ano %in% c("2014"))


### Identificando padrões com arrange () 
tbl_df(df) %>% arrange(Ano) %>% head

tbl_df(df)  %>% arrange(Mes)

tbl_df(df)  %>% select(Mes, Ano, Total)  %>% arrange(Mes)

tbl_df(df)  %>% select(Mes, Ano, Total)  %>% arrange(Mes) %>% filter(Total > median(Total, na.rm = TRUE))

tbl_df(df)  %>% select(Mes, Ano, Total)  %>% arrange(Mes) %>% filter(Ano >= 2011)

tbl_df(df)  %>% select(Mes, Ano, Total)  %>% arrange(Mes, desc(Mes)) %>% filter(Ano >= 2011)

head(df)


### Melhorar a exibição
options(digits = 3)
head(df)


### Informações sobre os valores da coluna Total
df  %>% summarise(AvgTotal = mean(Total),
                  MinTotal = min(Total),
                  MaxTotal = max(Total),
                  total = n())


### Análise de Grupos (Ano)
df  %>% 
  group_by(Ano) %>%
  summarise(AvgTotal = mean(Total),
            MinTotal = min(Total),
            MaxTotal = max(Total),
            total = n())


### Análise de Grupos (Mês)
df  %>% 
  group_by(Mes) %>%
  summarise(AvgTotal = mean(Total),
            MinTotal = min(Total),
            MaxTotal = max(Total),
            total = n())


### Linegraph dos Totais de Ataques por Ano
dfA <- df  %>% 
  group_by(Ano) %>%
  summarise(Total = sum(Total),
            Meses = n())

dfA$Ano <- as.factor(dfA$Ano)
ggplot(dfA, aes(x = Ano, y = Total,  group = Ano)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Ano", y = "Número de Ataques", title = "Ataques Registrados pelo CertBR nos últimos 15 anos")
#Obs.: 2014 foi o pico mas, de maneira geral, o número de ataques é crescente

### Análises Diversas (Ataques de DOS acima da média)
df  %>% 
  select(Mes, Ano, DOS)   %>% 
  filter(DOS > mean(DOS))  %>%
  head


### Remodelagem dos dados com TidyR
df$Mes <- c(01, 02, 03, 04, 05, 06, 07, 08, 09, 10, 11, 12)
df$Mes <- as.factor(df$Mes)
df$Ano <- as.factor(df$Ano)

### Corrigindo sequência cronológica
df <- df  %>% select(Mes, Ano, Worm, Worm_P, DOS, DOS_P, Invasao, Invasao_P, Web, Web_P, Scan, Scan_P, Fraude, Fraude_P, Outros, Outros_P, Total)  %>% arrange(Mes, desc(Mes)) %>% arrange(Ano, desc(Ano))


### Linegraph dos Totais de Ataques por Mês
dfM <- df  %>% 
  group_by(Mes) %>%
  summarise(Total = sum(Total),
            Media = Total/15,
            Meses = n())

dfM$Mes <- as.factor(dfM$Mes)
ggplot(dfM, aes(x = Mes, y = Total,  group = Mes)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Mês", y = "Número de Ataques", title = "Ataques Registrados pelo CertBR nos últimos 15 anos (por mês)")
#Obs.: Percebemos que o segundo semestre costuma ser mais movimentado


### Analisando a relação entre Invasão e Scan
dfRelation <- df[(df$Invasao > median(df$Invasao)) & (df$Scan > median(df$Scan)), ]
dfRelation <- tbl_df(dfRelation)
sample_n(dfRelation, size = 12)


### Secção do dataframe 
dfC <- subset(df, select = c(Mes, Ano, Worm, Worm_P, DOS, DOS_P, Invasao, Invasao_P, Web, Web_P, Scan, Scan_P, Fraude, Fraude_P, Outros, Outros_P, Total))
dfN <- subset(df, select = c(Mes, Ano, Worm, DOS, Invasao, Web, Scan, Fraude, Outros))
dfP <- subset(df, select = c(Mes, Ano, Worm_P, DOS_P, Invasao_P, Web_P, Scan_P, Fraude_P, Outros_P))

### Dataframe Completo, Percentual, Valores Absolutos: tbl_df (melhorar a apresentação)
dfC <- tbl_df(dfC)
dfN <- tbl_df(dfN)
dfP <- tbl_df(dfP)

class(dfC)
head(dfC)


### Reduzindo a Complexidade com um DF sobre Invasões
dfinv <- dfC  %>% select(Ano, DOS, Invasao, Web)  %>% filter(Ano == 2016)
dfinv <- dfC  %>% select(Ano, DOS, Invasao, Web)
class(dfinv)
str(dfinv)
dfinv$DOS <- as.integer(dfinv$DOS)
str(dfinv)

as.tbl(dfinv)


# Linegraph do Total Geral de Ataques por Ano
dfCAno <- dfC  %>% 
  group_by(Ano) %>%
  summarise(Total = sum(Total),
            Meses = n())

dfCAno$Ano <- as.factor(dfCAno$Ano)
ggplot(dfCAno, aes(x = Ano, y = Total,  group = Ano)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Ano", y = "Número Total de Ataques", title = "Ataques Registrados pelo CertBR nos últimos 15 anos")
#Obs.: 2014 foi o pico mas, de maneira geral, o número de ataques é crescente


# Linegraph do Total Geral de Ataques com WORM por Ano
dfWORMAno <- dfC  %>% 
  group_by(Ano) %>%
  summarise(Total = sum(Worm),
            Meses = n())

dfWORMAno$Ano <- as.factor(dfWORMAno$Ano)
ggplot(dfWORMAno, aes(x = Ano, y = Total,  group = Ano)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Ano", y = "Número Total de Ataques com Worm", title = "Ataques Registrados pelo CertBR nos últimos 15 anos")
#Obs.: Já foram mais comuns no passado


# Linegraph do Total Geral de Ataques de DOS por Ano
dfDOSAno <- dfC  %>% 
  group_by(Ano) %>%
  summarise(Total = sum(DOS),
            Meses = n())

dfDOSAno$Ano <- as.factor(dfDOSAno$Ano)
ggplot(dfDOSAno, aes(x = Ano, y = Total,  group = Ano)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Ano", y = "Número Total de Ataques DOS", title = "Ataques Registrados pelo CertBR nos últimos 15 anos")
#Obs.: Crescente a partir de 2013


# Linegraph do Total Geral de Invasões por Ano
dfInvasaoAno <- dfC  %>% 
  group_by(Ano) %>%
  summarise(Total = sum(Invasao),
            Meses = n())

dfInvasaoAno$Ano <- as.factor(dfInvasaoAno$Ano)
ggplot(dfInvasaoAno, aes(x = Ano, y = Total,  group = Ano)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Ano", y = "Número Total de Invasões", title = "Ataques Registrados pelo CertBR nos últimos 15 anos")
#Obs.: Crescente a partir de 2011


# Linegraph do Total Geral de Ataques a Servidores Web por Ano
dfWebAno <- dfC  %>% 
  group_by(Ano) %>%
  summarise(Total = sum(Web),
            Meses = n())

dfWebAno$Ano <- as.factor(dfWebAno$Ano)
ggplot(dfWebAno, aes(x = Ano, y = Total,  group = Ano)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Ano", y = "Número Total de Ataques a Servidores Web", title = "Ataques Registrados pelo CertBR nos últimos 15 anos")
#Obs.: Crescente a partir de sempre


# Linegraph do Total Geral de Scan por Ano
dfScanAno <- dfC  %>% 
  group_by(Ano) %>%
  summarise(Total = sum(Scan),
            Meses = n())

dfScanAno$Ano <- as.factor(dfScanAno$Ano)
ggplot(dfScanAno, aes(x = Ano, y = Total,  group = Ano)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Ano", y = "Número Total de Scans", title = "Ataques Registrados pelo CertBR nos últimos 15 anos")
#Obs.: Crescente a partir de sempre (atividade preparatória)


# Linegraph do Total de Ataques por Fraudes por Ano
dfFraudeAno <- dfC  %>% 
  group_by(Ano) %>%
  summarise(Total = sum(Fraude),
            Meses = n())

dfFraudeAno$Ano <- as.factor(dfFraudeAno$Ano)
ggplot(dfFraudeAno, aes(x = Ano, y = Total,  group = Ano)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Ano", y = "Número Total de Ataques por Fraudes", title = "Ataques Registrados pelo CertBR nos últimos 15 anos")
#Obs.: Cresce mais lentamente


# Linegraph do Total de Outros Atques por Ano
dfOutrosAno <- dfC  %>% 
  group_by(Ano) %>%
  summarise(Total = sum(Outros),
            Meses = n())

dfOutrosAno$Ano <- as.factor(dfOutrosAno$Ano)
ggplot(dfOutrosAno, aes(x = Ano, y = Total,  group = Ano)) + 
  geom_line(aes(group = 1)) +
  geom_smooth(method = "loess", size = 1, aes(group = 1), se = T) + 
  labs(x = "Ano", y = "Número Total de Ataques por Fraudes", title = "Ataques Registrados pelo CertBR nos últimos 15 anos")
#Obs.: Os critérios de classificação tem evoluído 


# Linegraph dos Percentuais por Modalidaed de Ataques
ggplot(dfP, aes(x = Ano, y , group = Mes, colour = Modalidades)) + 
  geom_line(aes(y = Worm_P, colour = "Worm")) + 
  geom_line(aes(y = DOS_P, colour = "DOS")) +
  geom_line(aes(y = Invasao_P, colour = "Invasão")) +
  geom_line(aes(y = Web_P, colour = "Web")) +
  geom_line(aes(y = Fraude_P, colour = "Fraude")) +
  geom_line(aes(y = Outros_P, colour = "Outros")) +
  labs(x = "Ano", y = "Número de Ataques (%)", title = "Percentuais por Modalidaed de Ataques Registrados pelo CertBR")


# Linegraph dos Percentuais por Modalidaed de Ataques em 2012
# (Conferência das Nações Unidas sobre Desenvolvimento Natural - Rio+20, de 13 e 22 de junho de 2012)
dfP2012 <- tbl_df(dfP)  %>% arrange(Mes) %>% filter(Ano == 2012)
dfP2012$Mes <- as.factor(dfP2012$Mes)
ggplot(dfP2012, aes(x = Mes, y , group = 1, colour = Modalidades)) + 
  geom_line(aes(y = Worm_P, colour = "Worm")) + 
  geom_line(aes(y = DOS_P, colour = "DOS")) +
  geom_line(aes(y = Invasao_P, colour = "Invasão")) +
  geom_line(aes(y = Web_P, colour = "Web")) +
  geom_line(aes(y = Fraude_P, colour = "Fraude")) +
  geom_line(aes(y = Outros_P, colour = "Outros")) +
  labs(x = "Mês", y = "Número de Ataques (%)", title = "Percentuais por Modalidaed de Ataques Registrados pelo CertBR em 2012")


# Linegraph dos Percentuais por Modalidaed de Ataques em 2013
# (XXVIII Jornada Mundial da Juventude aconteceu de 23 a 28 de julho de 2013)
# (Copa das Confederações de Futebol de 15 a 30 de junho de 2013)
dfP2013 <- tbl_df(dfP)  %>% arrange(Mes) %>% filter(Ano == 2013)
dfP2013$Mes <- as.factor(dfP2013$Mes)
ggplot(dfP2013, aes(x = Mes, y , group = 1, colour = Modalidades)) + 
  geom_line(aes(y = Worm_P, colour = "Worm")) + 
  geom_line(aes(y = DOS_P, colour = "DOS")) +
  geom_line(aes(y = Invasao_P, colour = "Invasão")) +
  geom_line(aes(y = Web_P, colour = "Web")) +
  geom_line(aes(y = Fraude_P, colour = "Fraude")) +
  geom_line(aes(y = Outros_P, colour = "Outros")) +
  labs(x = "Mês", y = "Número de Ataques (%)", title = "Percentuais por Modalidaed de Ataques Registrados pelo CertBR em 2013")


# Linegraph dos Percentuais por Modalidaed de Ataques em 2014
# (Copa do Mundo, de 12 de junho a 13 de julho de 2014)
dfP2014 <- tbl_df(dfP)  %>% arrange(Mes) %>% filter(Ano == 2014)
dfP2014$Mes <- as.factor(dfP2014$Mes)
ggplot(dfP2014, aes(x = Mes, y , group = 1, colour = Modalidades)) + 
  geom_line(aes(y = Worm_P, colour = "Worm")) + 
  geom_line(aes(y = DOS_P, colour = "DOS")) +
  geom_line(aes(y = Invasao_P, colour = "Invasão")) +
  geom_line(aes(y = Web_P, colour = "Web")) +
  geom_line(aes(y = Fraude_P, colour = "Fraude")) +
  geom_line(aes(y = Outros_P, colour = "Outros")) +
  labs(x = "Mês", y = "Número de Ataques (%)", title = "Percentuais por Modalidaed de Ataques Registrados pelo CertBR em 2014")


# Linegraph dos Percentuais por Modalidaed de Ataques em 2015
dfP2015 <- tbl_df(dfP)  %>% arrange(Mes) %>% filter(Ano == 2015)
dfP2015$Mes <- as.factor(dfP2015$Mes)
ggplot(dfP2015, aes(x = Mes, y , group = 1, colour = Modalidades)) + 
  geom_line(aes(y = Worm_P, colour = "Worm")) + 
  geom_line(aes(y = DOS_P, colour = "DOS")) +
  geom_line(aes(y = Invasao_P, colour = "Invasão")) +
  geom_line(aes(y = Web_P, colour = "Web")) +
  geom_line(aes(y = Fraude_P, colour = "Fraude")) +
  geom_line(aes(y = Outros_P, colour = "Outros")) +
  labs(x = "Mês", y = "Número de Ataques (%)", title = "Percentuais por Modalidaed de Ataques Registrados pelo CertBR em 2015")


# Linegraph dos Percentuais por Modalidaed de Ataques em 2016
# (Jogos Olímpicos Rio 2016, de 5 a 21 de agosto)
# (Paralimpíadas Rio 2016, de 7 a 18 de setembro)
dfP2016 <- tbl_df(dfP)  %>% arrange(Mes) %>% filter(Ano == 2016)
dfP2016$Mes <- as.factor(dfP2016$Mes)
ggplot(dfP2016, aes(x = Mes, y , group = 1, colour = Modalidades)) + 
  geom_line(aes(y = Worm_P, colour = "Worm")) + 
  geom_line(aes(y = DOS_P, colour = "DOS")) +
  geom_line(aes(y = Invasao_P, colour = "Invasão")) +
  geom_line(aes(y = Web_P, colour = "Web")) +
  geom_line(aes(y = Fraude_P, colour = "Fraude")) +
  geom_line(aes(y = Outros_P, colour = "Outros")) +
  labs(x = "Mês", y = "Número de Ataques (%)", title = "Percentuais por Modalidaed de Ataques Registrados pelo CertBR em 2016")




